# Copy this file to .github/workflows/sdlc-ci-fixer.yml in your repository
# This workflow monitors CI check completion:
#   - On failure: Analyzes errors, posts fix suggestions, and triggers Coder to fix
#   - On success: Adds "agent-review" label to trigger the reviewer agent
#
# Triggers:
#   - When a PR is opened, synchronized, or ready for review
#   - Waits for all CI checks to complete before running
#
# Required secrets:
#   - GH_TOKEN: GitHub Personal Access Token with repo scope
#   - LLM_API_TOKEN: Your LLM API key

name: CI Monitor

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]

jobs:
  # Wait for CI and then analyze/respond
  monitor_ci:
    name: Monitor CI
    # Skip draft PRs
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.pr.outputs.number }}
      issue_number: ${{ steps.issue.outputs.number }}
      head_ref: ${{ steps.pr.outputs.head_ref }}
      ci_status: ${{ steps.checks.outputs.status }}
    steps:
      - name: Get PR info
        id: pr
        run: |
          echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "head_ref=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          echo "head_sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT

      - name: Wait for CI checks to complete
        id: checks
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "Waiting for CI checks to complete..."
          PR_NUMBER=${{ github.event.pull_request.number }}
          
          # Wait up to 15 minutes for checks, polling every 30 seconds
          for i in {1..30}; do
            # Get check status, excluding our own workflows
            STATUS=$(gh pr checks $PR_NUMBER --repo ${{ github.repository }} --json name,state --jq '
              [.[] | select(
                .name != "Monitor CI" and 
                .name != "Analyze CI Failures" and 
                .name != "Fix CI Failures (auto)" and 
                .name != "Review PR" and 
                .name != "Fix Issues (auto)"
              )] | 
              map(.state) | 
              if length == 0 then "none" 
              elif all(. == "SUCCESS" or . == "SKIPPED") then "success" 
              elif any(. == "PENDING" or . == "QUEUED" or . == "IN_PROGRESS") then "pending" 
              else "failure" 
              end
            ' 2>/dev/null || echo "pending")
            
            echo "Check status (attempt $i): $STATUS"
            
            if [ "$STATUS" = "success" ]; then
              echo "✅ All CI checks passed!"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            elif [ "$STATUS" = "failure" ]; then
              echo "❌ CI checks failed!"
              echo "status=failure" >> $GITHUB_OUTPUT
              exit 0
            elif [ "$STATUS" = "none" ]; then
              echo "No CI checks found, treating as success"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            echo "Checks still pending, waiting 30s..."
            sleep 30
          done
          
          echo "⏱️ Timeout waiting for checks"
          echo "status=timeout" >> $GITHUB_OUTPUT

      - name: Get linked issue number
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Get PR body and extract issue number
          ISSUE_NUM=$(gh pr view ${{ steps.pr.outputs.number }} --repo ${{ github.repository }} --json body --jq '.body' | grep -oE '#[0-9]+' | head -1 | tr -d '#')
          echo "number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "Linked issue: #$ISSUE_NUM"

  # When CI fails, analyze and post suggestions
  analyze_failures:
    name: Analyze CI Failures
    needs: monitor_ci
    if: needs.monitor_ci.outputs.ci_status == 'failure'
    runs-on: ubuntu-latest
    outputs:
      analyzed: ${{ steps.analyze.outputs.analyzed }}
    steps:
      - name: Remove agent-review label if present
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          gh pr edit ${{ needs.monitor_ci.outputs.pr_number }} --repo ${{ github.repository }} --remove-label "agent-review" 2>/dev/null || true

      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: repo

      - name: Checkout agent code
        uses: actions/checkout@v4
        with:
          repository: Astro-Peter/coding-agent-megaschool
          path: agent

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -e ./agent

      - name: Run CI Fixer Agent
        id: analyze
        working-directory: repo
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ needs.monitor_ci.outputs.pr_number }}
          LLM_API_TOKEN: ${{ secrets.LLM_API_TOKEN }}
          LLM_API_URL: ${{ vars.LLM_API_URL || 'https://openrouter.ai/api/v1' }}
          LLM_MODEL: ${{ vars.LLM_MODEL_STRUCTURED || vars.LLM_MODEL || 'gpt-4o-mini' }}
          GITHUB_WORKSPACE: ${{ github.workspace }}/repo
        run: |
          python -m github_agents.ci_fixer_agent.agent
          echo "analyzed=true" >> $GITHUB_OUTPUT

  # After analysis, trigger coder to fix the issues
  fix_ci_failures:
    name: Fix CI Failures (auto)
    needs: [monitor_ci, analyze_failures]
    # Only run if we have a linked issue number and analysis completed
    if: needs.monitor_ci.outputs.issue_number != '' && needs.analyze_failures.outputs.analyzed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.monitor_ci.outputs.head_ref }}
          fetch-depth: 0
          path: repo

      - name: Checkout agent code
        uses: actions/checkout@v4
        with:
          repository: Astro-Peter/coding-agent-megaschool
          path: agent

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -e ./agent

      - name: Configure Git
        working-directory: repo
        run: |
          git config user.name "CI Fixer Bot"
          git config user.email "ci-fixer-bot@users.noreply.github.com"

      - name: Run Coder Agent to fix CI issues
        working-directory: repo
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_REPOSITORY: ${{ github.repository }}
          ISSUE_NUMBER: ${{ needs.monitor_ci.outputs.issue_number }}
          PR_NUMBER: ${{ needs.monitor_ci.outputs.pr_number }}
          LLM_API_TOKEN: ${{ secrets.LLM_API_TOKEN }}
          LLM_API_URL: ${{ vars.LLM_API_URL || 'https://openrouter.ai/api/v1' }}
          LLM_MODEL: ${{ vars.LLM_MODEL || 'gpt-4o-mini' }}
          GITHUB_WORKSPACE: ${{ github.workspace }}/repo
          # Signal to coder that this is a CI fix context
          CI_FIX_MODE: "true"
        run: python -m github_agents.coder_agent.run_from_plan

  # When CI passes, add label to trigger reviewer
  trigger_review:
    name: Trigger Review
    needs: monitor_ci
    if: needs.monitor_ci.outputs.ci_status == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Add agent-review label
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "All CI checks passed! Adding agent-review label to trigger reviewer..."
          
          # Create the label if it doesn't exist
          gh label create "agent-review" --repo ${{ github.repository }} --description "Ready for AI agent review" --color "0E8A16" 2>/dev/null || true
          
          # Add the label to the PR
          gh pr edit ${{ needs.monitor_ci.outputs.pr_number }} --repo ${{ github.repository }} --add-label "agent-review"
          
          echo "✅ Label added. Reviewer agent will be triggered."
